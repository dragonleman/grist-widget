<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activities Declaration</title>
  <link rel="stylesheet" href="https://web2018.epfl.ch/8.3.0/css/elements.min.css">
  <link rel="stylesheet" href="css/declprofs.css">
	<script src="https://web2018.epfl.ch/8.3.0/js/elements.min.js"></script>
</head>
<body>
  	<header class="header header-light my-2">
		<div class="header-light-content">
			<a class="logo" href="https://www.epfl.ch"><img src="img/epfl_small.png" alt="Logo EPFL" class="img-fluid"></a>
			<p class="site-title"><a href="#">Professor outside activities</a></p>
			<nav class="nav-lang nav-lang-short ml-auto pr-lg-5"></nav>
		</div>
  	</header>

	<div class="breadcrumb-container pb-0 mb-0">
		<nav aria-label="breadcrumb" class="breadcrumb-wrapper" id="breadcrumb-wrapper"></nav>
	</div>
  
  	<div class="main-container m-4">
		<div class="p-3" style="text-align:right">
			<button id="addBtn" class="btn btn-primary btn-sm">Add new activity</button>
		</div>

		<div>
			<div id="form" class="form-container"></div>
		</div>

		<div style="display:flex; gap:10px; margin-bottom:10px;">
			<button id="prevBtn" class="btn btn-secondary btn-sm ml-2">Previous</button>
			<span id="navCounter"></span>
			<button id="nextBtn" class="btn btn-secondary btn-sm ml-2">Next</button>
		</div>
	</div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

	<script>
		const addButton = document.getElementById('addBtn');
		const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
		let allRecords = [];
		let selectedId = null;

		const columnNamesAccepted = ['Name', 'Activity', 'Start_date', 'End_date', 'Access', 'Comments', 'Comments_admins', 'UpdatedAt'];
		const transColumns = {
			Name: "Name",
			Activity: "Activity",
			Start_date: "Start date",
			End_date: "End date",
			Access: "Access",
			exception: "Exception",
			Comments: "Comments",
			Comments_admins: "Comments admins",
			UpdatedAt: "Updated at"
		};

		grist.ready({ requiredAccess: 'full', getSelectedRows: true, allowSelectBy: true });

		function renderForm(rec) {
			const form = document.getElementById('form');
			form.innerHTML = '';

			if (!rec) {
				form.textContent = 'No record selected.';
				return;
			}

			// Helper Bootstrap form-group
			const field = ({ labelText, inputEl, id, helpText = '' }) => {
				const wrapper = document.createElement('div');
				wrapper.className = 'form-group';

				const label = document.createElement('label');
				label.setAttribute('for', id);
				label.textContent = labelText;

				inputEl.id = id;
				inputEl.classList.add('form-control');

				wrapper.appendChild(label);
				wrapper.appendChild(inputEl);

				if (helpText) {
				const small = document.createElement('small');
				small.id = `${id}-help`;
				small.className = 'form-text text-muted';
				small.textContent = helpText;
				inputEl.setAttribute('aria-describedby', small.id);
				wrapper.appendChild(small);
				}

				return wrapper;
			};

			const is_read_only = rec.Access === "ðŸ›‘" && !("Name" in rec);

			// Name (read-only)
			if ('Name' in rec) {
				const input = document.createElement('input');
				input.type = 'text';
				input.value = rec.Name || '';
				input.readOnly = true;

				form.appendChild(
				field({
					labelText: transColumns.Name,
					inputEl: input,
					id: 'name-input'
				})
				);
			}

			// Activity
			if ('Activity' in rec) {
				const input = document.createElement('input');
				input.type = 'text';
				input.value = rec.Activity || '';
				input.readOnly = is_read_only;

				input.addEventListener('blur', async () => {
				if (input.value !== rec.Activity) {
					await grist.selectedTable.update({
					id: rec.id,
					fields: { Activity: input.value }
					});
				}
				});

				form.appendChild(
				field({
					labelText: transColumns.Activity,
					inputEl: input,
					id: 'activity-input'
				})
				);
			}

			// === Start_date + End_date on same row ===
			if ('Start_date' in rec || 'End_date' in rec) {
				const row = document.createElement('div');
				row.className = 'row';

				// Start_date (50%)
				if ('Start_date' in rec) {
					const col = document.createElement('div');
					col.className = 'col-6';

					const input = document.createElement('input');
					input.type = 'date';
					input.value = rec.Start_date || '';
					input.readOnly = is_read_only;

					input.addEventListener('blur', async () => {
						if (input.value !== rec.Start_date) {
						await grist.selectedTable.update({
							id: rec.id,
							fields: { Start_date: input.value }
						});
						}
					});

					col.appendChild(
						field({
						labelText: transColumns.Start_date,
						inputEl: input,
						id: 'start-date-input'
						})
					);

					row.appendChild(col);
				}

				// End_date (50%)
				if ('End_date' in rec) {
					const col = document.createElement('div');
					col.className = 'col-6';

					const input = document.createElement('input');
					input.type = 'date';
					input.value = rec.End_date || '';
					input.style.backgroundColor = rec.ErrorDate || '';
					input.readOnly = is_read_only;

					input.addEventListener('blur', async () => {
						if (input.value !== rec.End_date) {
						await grist.selectedTable.update({
							id: rec.id,
							fields: { End_date: input.value }
						});
						}
					});

					col.appendChild(
						field({
						labelText: transColumns.End_date,
						inputEl: input,
						id: 'end-date-input'
						})
					);

					row.appendChild(col);
				}

				form.appendChild(row);
			}

			// Comments
			if ('Comments' in rec) {
				const input = document.createElement('input');
				input.type = 'text';
				input.value = rec.Comments || '';
				input.readOnly = is_read_only;

				input.addEventListener('blur', async () => {
				if (input.value !== rec.Comments) {
					await grist.selectedTable.update({
					id: rec.id,
					fields: { Comments: input.value }
					});
				}
				});

				form.appendChild(
				field({
					labelText: transColumns.Comments,
					inputEl: input,
					id: 'comments-input'
				})
				);
			}

			// Comments_admins
			if ('Comments_admins' in rec) {
				const input = document.createElement('input');
				input.type = 'text';
				input.value = rec.Comments_admins || '';
				input.readOnly = is_read_only;

				input.addEventListener('blur', async () => {
				if (input.value !== rec.Comments_admins) {
					await grist.selectedTable.update({
					id: rec.id,
					fields: { Comments_admins: input.value }
					});
				}
				});

				form.appendChild(
				field({
					labelText: transColumns.Comments_admins,
					inputEl: input,
					id: 'comments-admins-input'
				})
				);
			}

			// UpdatedAt (read-only)
			if ('UpdatedAt' in rec) {
				const input = document.createElement('input');
				input.type = 'date';
				input.value = rec.UpdatedAt
				? new Date(rec.UpdatedAt).toISOString().substring(0, 10)
				: '';
				input.readOnly = true;

				form.appendChild(
				field({
					labelText: transColumns.UpdatedAt,
					inputEl: input,
					id: 'updated-at-input'
				})
				);
			}
		}


		addButton.addEventListener('click', async () => {
			const result = await window.grist.selectedTable.create({
				fields: {
				Activity: "",
				Start_date: today,
				End_date: today,
				},
			});

			window.grist.setCursorPos({ rowId: result.id });
		});

		function selectRowFromWidget(record) {
			if (!record) return;

			selectedId = record.id;

			grist.setCursorPos([record.id]);

			renderForm(record);

			const index = allRecords.findIndex(r => r.id === record.id);
			document.getElementById("navCounter").textContent = `${index + 1} / ${allRecords.length}`;
		}

		document.getElementById("nextBtn").addEventListener("click", () => {
			const index = allRecords.findIndex(r => r.id === selectedId);
			if (index >= 0 && index < allRecords.length - 1) {
				selectRowFromWidget(allRecords[index + 1]);
			}
		});

		document.getElementById("prevBtn").addEventListener("click", () => {
			const index = allRecords.findIndex(r => r.id === selectedId);
			if (index > 0) {
				selectRowFromWidget(allRecords[index - 1]);
			}
		});

		grist.onRecords(records => {
			allRecords = records;
		});

		grist.onRecord(record => {
			if (!record) return;

			selectedId = record.id;

			renderForm(record);

			const index = allRecords.findIndex(r => r.id === record.id);
			document.getElementById("navCounter").textContent = `${index + 1} / ${allRecords.length}`;
		});
	</script>

	<script>
    	svgPath = 'https://web2018.epfl.ch/8.3.0/icons/icons.svg';
    	featherSvgPath = 'https://web2018.epfl.ch/8.3.0/icons/feather-sprite.svg';
  	</script>
</body>
</html>


