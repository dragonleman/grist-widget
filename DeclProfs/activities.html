<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activities Declaration</title>
  <link rel="stylesheet" href="//web2018.epfl.ch/8.2.0/css/elements.min.css">
</head>
<body>
  <header role="banner" class="header">
    <a class="logo" href="#">
      <img src="img/epfl_small.png" alt="Logo EPFL" class="img-fluid">
    </a>
    
    <nav class="ml-auto">
      <div id="user-info"></div>
    </nav>
  </header>

  <div class="p-3" style="text-align:right"><button id="addBtn" class="btn btn-primary btn-sm">Add new activity</button></div>

	<div>
		<table id="table" class="table table-boxed"></table>
	</div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<script>
		const addButton = document.getElementById('addBtn');
	  
	  const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
	  
		window.grist.ready({ requiredAccess: 'full' });

		window.grist.onRecords((records) => {
		  
		  let columnNames = []
		  if (records.length > 0) {
		    columnNames = Object.keys(records[0]);
				console.log("Colonnes disponibles :", columnNames);
			}
			
			const columnNamesAccepted = ['Name', 'Email', 'Activity', 'Start_date', 'End_date', 'Rate_', 'Access', 'exception'] 
  
		  const table = document.getElementById('table');

		  // Efface tout
		  while (table.rows.length > 0) table.deleteRow(0);

		  if (!records || records.length === 0) {
		    const row = table.insertRow();
		    const cell = row.insertCell();
		    cell.colSpan = 6;
		    cell.textContent = 'Aucune donnÃ©e trouvÃ©e.';
		    cell.style.textAlign = 'center';
		    return;
		  }
		  
		  const header = table.insertRow();
		  
			for (const col of columnNames) {
			  if (columnNamesAccepted.includes(col)) {
					const th = document.createElement('th');
					th.textContent = col;
					header.appendChild(th);
				}
			}
			
			const th = document.createElement('th');
			th.textContent = 'Actions';
			header.appendChild(th);
			
		  for (const rec of records) {
		    const row = table.insertRow();
		    
		    // Name
		    if (columnNames.includes('Name')) {
				  const nameCell = row.insertCell();
				  const nameSpan = document.createElement('span');
				  nameSpan.textContent = rec.Name || '';
				  nameSpan.style.border = 'none';
				  nameCell.appendChild(nameSpan);
		    }

		    // Activity
		    if (columnNames.includes('Activity')) {
				  const activityCell = row.insertCell();
				  const activityInput = document.createElement('input');
				  activityInput.value = rec.Activity || '';
				  activityInput.style.border = 'none';
				  activityInput.addEventListener('blur', async () => {
				    if (activityInput.value !== rec.Activity) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Activity: activityInput.value }
				      });
				    }
				  });
				  activityCell.appendChild(activityInput);
		    }

		    // Start date
		    if (columnNames.includes('Start_date')) {
				  const startCell = row.insertCell();
				  const startInput = document.createElement('input');
				  startInput.type = 'date';
				  startInput.value = rec.Start_date || '';
				  startInput.style.border = 'none';
				  startInput.addEventListener('blur', async () => {
				    if (startInput.value !== rec.Start_date) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Start_date: startInput.value }
				      });
				    }
				  });
				  startCell.appendChild(startInput);
		    }

		    // End date
		    if (columnNames.includes('End_date')) {
				  const endCell = row.insertCell();
				  const endInput = document.createElement('input');
				  endInput.type = 'date';
				  endInput.value = rec.End_date || '';
				  endInput.style.border = 'none';
				  endInput.style.backgroundColor = rec.ErrorDate || 'white';
				  endInput.addEventListener('blur', async () => {
				    if (endInput.value !== rec.End_date) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { End_date: endInput.value }
				      });
				    }
				  });
				  endCell.appendChild(endInput);
		    }

		    // Rate (%)
		    if (columnNames.includes('Rate_')) {
				  const rateCell = row.insertCell();
				  const rateInput = document.createElement('input');
				  rateInput.type = 'number';
				  rateInput.min = 0;
				  rateInput.max = 100;
				  rateInput.value = rec.Rate_ || 0;
				  rateInput.style.border = 'none';
				  rateInput.style.textAlign = 'right';
					rateInput.style.width = '60px';
				  rateInput.addEventListener('blur', async () => {
				    const newValue = parseFloat(rateInput.value);
				    if (newValue !== rec.Rate_) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Rate_: newValue }
				      });
				    }
				  });
				  rateCell.appendChild(rateInput);
		    }

		    // Access
				if (columnNames.includes('Access')) {
					const accessCell = row.insertCell();
					const icon = document.createElement('span');
					icon.style.fontSize = '18px';
					icon.style.cursor = 'default'; // non cliquable
					icon.textContent = rec.Access;
					accessCell.appendChild(icon);
				}	

				// Actions (Duplicate + Delete)
		    const tdActions = row.insertCell();

		    // Duplicate
		    const dupBtn = document.createElement('button');
		    dupBtn.textContent = 'ðŸ”';
		    dupBtn.title = "Dupliquer";
		    dupBtn.style.border = 'none';
		    dupBtn.onclick = async () => {
		      await window.grist.selectedTable.create({
		        fields: {
		          Activity: rec.Activity,
		          Start_date: today,
		          End_date: today,
		          Rate_: rec.Rate_,
		        },
		      });
		    };
		    tdActions.appendChild(dupBtn);

		    // Delete
		    const delBtn = document.createElement('button');
		    delBtn.textContent = 'ðŸ—‘ï¸';
		    delBtn.title = "Supprimer";
		    delBtn.style.marginLeft = '5px';
		    delBtn.style.border = 'none';
		    delBtn.onclick = async () => {
		      const confirmDelete = confirm(`Supprimer "${rec.Activity}" ?`);
		      if (!confirmDelete) return;
		      await window.grist.selectedTable.destroy([rec.id]);
		      row.remove();
		    };
		    tdActions.appendChild(delBtn);
		    
		    // Download CSV
				const dlBtn = document.createElement('button');
				dlBtn.textContent = 'ðŸ“¥';
				dlBtn.title = "TÃ©lÃ©charger en CSV";
				dlBtn.style.marginLeft = '5px';
				dlBtn.style.border = 'none';

				dlBtn.onclick = () => {
					// RÃ©cupÃ©rer les paires clÃ© => valeur
					const keys = Object.keys(rec);
					const values = keys.map(k => rec[k] ?? "");

					// Construire CSV
					const csvContent =
						keys.join(",") + "\n" +
						values.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",");

					// CrÃ©er un blob
					const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

					// CrÃ©er un lien temporaire
					const link = document.createElement("a");
					link.href = URL.createObjectURL(blob);

					// Nom du fichier (ex: Activity_123.csv)
					link.download = `${rec.Activity || "ligne"}_${rec.id}.csv`;

					// TÃ©lÃ©charger
					link.click();

					// Nettoyer lâ€™URL Blob
					URL.revokeObjectURL(link.href);
				};

				tdActions.appendChild(dlBtn);
		  }
		});
		
		addButton.addEventListener('click', async () => {
			await grist.selectedTable.create({
			  fields: {
          Activity: "",
          Start_date: today,
          End_date: today,
          Rate_: 0,
        },
			}) 
		});

	</script>
</body>
</html>


