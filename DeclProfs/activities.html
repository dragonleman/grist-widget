<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activities Declaration</title>
  <link rel="stylesheet" href="https://web2018.epfl.ch/8.3.0/css/elements.min.css">
  <link rel="stylesheet" href="css/declprofs.css">
	<script src="https://web2018.epfl.ch/8.3.0/js/elements.min.js"></script>
</head>
<body>
  <header role="banner" class="header">
    <a class="logo" href="#">
      <img src="img/epfl_small.png" alt="Logo EPFL" class="img-fluid">
    </a>
    
    <nav class="ml-auto">
      <div id="user-info"></div>
    </nav>
  </header>
  
	<div id="searchDiv" style="position: relative; max-width: 300px; display: none;">
		<input type="text" id="searchInput" placeholder="Search someone..." style="padding-left: 30px; box-sizing: border-box;">
		<svg class="icon" aria-hidden="true" 
		     style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
		  <use xlink:href="#icon-search"></use>
		</svg>
	</div>

	<div style="position: relative; max-width: 300px; display: none;">
		<input type="text" id="yearInput" placeholder="YYYY" style="padding-left: 30px; box-sizing: border-box;">
		<svg class="icon" aria-hidden="true" 
		     style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
		  <use xlink:href="#icon-calendar"></use>
		</svg>
	</div>	
	
	<div class="my-1">
		<label for="yearInput">Filter by year:</label>
		<input type="text" id="yearInput" maxlength="4" placeholder="YYYY" style="display:inline-block;">
	</div>

  <div class="p-3" style="text-align:right">
  	<button id="addBtn" class="btn btn-primary btn-sm">Add new activity</button>
  </div>

	<div>
		<table id="table" class="table table-boxed"></table>
	</div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<script>
		const addButton = document.getElementById('addBtn');
		const searchInput = document.getElementById('searchInput');
		const yearInput = document.getElementById("yearInput");

	  const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
	  let allRecords = [];
	  
		window.grist.ready({ requiredAccess: 'full' });

		function renderTable(records) {
		  
		  let columnNames = []
		  if (records.length > 0) {
		    columnNames = Object.keys(records[0]);
				console.log("Colonnes disponibles :", columnNames);
			}
			
			const columnNamesAccepted = ['Name', 'Activity', 'Start_date', 'End_date', 'Rate_', 'Access', 'exception'] 
  
		  const table = document.getElementById('table');

		  // Efface tout
		  while (table.rows.length > 0) table.deleteRow(0);

		  if (!records || records.length === 0) {
		    const row = table.insertRow();
		    const cell = row.insertCell();
		    cell.colSpan = 6;
		    cell.textContent = 'Aucune donn√©e trouv√©e.';
		    cell.style.textAlign = 'center';
		    return;
		  }
		  
		  const header = table.insertRow();
		  
			for (const col of columnNamesAccepted) {
			  if (columnNames.includes(col)) {
			    if (col == 'Name') {
			      document.getElementById('searchDiv').style.display = 'block';
			    }
					const th = document.createElement('th');
					th.textContent = col;
					header.appendChild(th);
				}
			}
			
			const th = document.createElement('th');
			th.textContent = 'Actions';
			header.appendChild(th);
			
		  for (const rec of records) {
		    const row = table.insertRow();
		    
		    // Name
		    if (columnNames.includes('Name')) {
				  const nameCell = row.insertCell();
				  const nameSpan = document.createElement('span');
				  nameSpan.textContent = rec.Name || '';
				  nameSpan.style.border = 'none';
				  nameCell.appendChild(nameSpan);
		    }
		    
		    // Activity
		    if (columnNames.includes('Activity')) {
				  const activityCell = row.insertCell();
				  const activityInput = document.createElement('input');
				  activityInput.value = rec.Activity || '';
				  activityInput.style.border = 'none';
				  activityInput.addEventListener('blur', async () => {
				    if (activityInput.value !== rec.Activity) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Activity: activityInput.value }
				      });
				    }
				  });
				  activityCell.appendChild(activityInput);
		    }

		    // Start date
		    if (columnNames.includes('Start_date')) {
				  const startCell = row.insertCell();
				  const startInput = document.createElement('input');
				  startInput.type = 'date';
				  startInput.value = rec.Start_date || '';
				  startInput.style.border = 'none';
				  startInput.addEventListener('blur', async () => {
				    if (startInput.value !== rec.Start_date) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Start_date: startInput.value }
				      });
				    }
				  });
				  startCell.appendChild(startInput);
		    }

		    // End date
		    if (columnNames.includes('End_date')) {
				  const endCell = row.insertCell();
				  const endInput = document.createElement('input');
				  endInput.type = 'date';
				  endInput.value = rec.End_date || '';
				  endInput.style.border = 'none';
				  endInput.style.backgroundColor = rec.ErrorDate || '';
				  endInput.addEventListener('blur', async () => {
				    if (endInput.value !== rec.End_date) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { End_date: endInput.value }
				      });
				    }
				  });
				  endCell.appendChild(endInput);
		    }

		    // Rate (%)
		    if (columnNames.includes('Rate_')) {
				  const rateCell = row.insertCell();
				  const rateInput = document.createElement('input');
				  rateInput.type = 'number';
				  rateInput.min = 0;
				  rateInput.max = 100;
				  rateInput.value = rec.Rate_ || 0;
				  rateInput.style.border = 'none';
				  rateInput.style.textAlign = 'right';
					rateInput.style.width = '60px';
				  rateInput.addEventListener('blur', async () => {
				    const newValue = parseFloat(rateInput.value);
				    if (newValue !== rec.Rate_) {
				      await window.grist.selectedTable.update({
				        id: rec.id,
				        fields: { Rate_: newValue }
				      });
				    }
				  });
				  rateCell.appendChild(rateInput);
		    }

		    // Access
				if (columnNames.includes('Access')) {
					const accessCell = row.insertCell();
					const icon = document.createElement('span');
					icon.style.fontSize = '18px';
					icon.style.cursor = 'default'; // non cliquable
					icon.textContent = rec.Access;
					accessCell.appendChild(icon);
				}
				
				// Exception
				if (columnNames.includes('exception')) {
					const exceptionCell = row.insertCell();

					// Wrapper
					const wrapper = document.createElement('div');
					wrapper.className = 'custom-control custom-switch';

					// ID unique par ligne
					const switchId = `switch-exception-${rec.id}`;

					// Input checkbox
					const toggle = document.createElement('input');
					toggle.type = 'checkbox';
					toggle.className = 'custom-control-input';
					toggle.id = switchId;

					// Valeur initiale depuis Grist
					toggle.checked = Boolean(rec.exception);

					// Label
					const label = document.createElement('label');
					label.className = 'custom-control-label';
					label.htmlFor = switchId;
					label.textContent = '';  // laisser vide si tu ne veux pas de texte

					// Push dans DOM
					wrapper.appendChild(toggle);
					wrapper.appendChild(label);
					exceptionCell.appendChild(wrapper);

					// Mise √† jour Grist lorsque l'utilisateur clique
					toggle.addEventListener('change', async () => {
						await window.grist.selectedTable.update({
							id: rec.id,
							fields: { exception: toggle.checked }
						});
					});
				}

				// Actions (Duplicate + Delete)
		    const tdActions = row.insertCell();

		    // Duplicate
		    const dupBtn = document.createElement('button');
		    dupBtn.title = "Dupliquer";
		    //dupBtn.textContent = 'üîÅ';
		    dupBtn.innerHTML = `
					<svg class="icon" aria-hidden="true">
						<use xlink:href="#copy"></use>
					</svg>
				`;
		    dupBtn.style.border = 'none';
		    dupBtn.onclick = async () => {
		      await window.grist.selectedTable.create({
		        fields: {
		          Activity: rec.Activity,
		          Start_date: today,
		          End_date: today,
		          Rate_: rec.Rate_,
		        },
		      });
		    };
		    tdActions.appendChild(dupBtn);

		    // Delete
		    const delBtn = document.createElement('button');
		    //delBtn.textContent = 'üóëÔ∏è';
		    delBtn.innerHTML = `
					<svg class="icon" aria-hidden="true">
						<use xlink:href="#delete"></use>
					</svg>
				`;
		    delBtn.title = "Supprimer";
		    delBtn.style.marginLeft = '5px';
		    delBtn.style.border = 'none';
		    delBtn.onclick = async () => {
		      const confirmDelete = confirm(`Supprimer "${rec.Activity}" ?`);
		      if (!confirmDelete) return;
		      await window.grist.selectedTable.destroy([rec.id]);
		      row.remove();
		    };
		    tdActions.appendChild(delBtn);
		    
		    // Download CSV
				const dlBtn = document.createElement('button');
				//dlBtn.textContent = 'üì•';
		    dlBtn.innerHTML = `
					<svg class="icon" aria-hidden="true">
						<use xlink:href="#download"></use>
					</svg>
				`;
				dlBtn.title = "T√©l√©charger en CSV";
				dlBtn.style.marginLeft = '5px';
				dlBtn.style.border = 'none';

				dlBtn.onclick = () => {
					// R√©cup√©rer les paires cl√© => valeur
					const keys = Object.keys(rec);
					const values = keys.map(k => rec[k] ?? "");

					// Construire CSV
					const csvContent =
						keys.join(",") + "\n" +
						values.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",");

					// Cr√©er un blob
					const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

					// Cr√©er un lien temporaire
					const link = document.createElement("a");
					link.href = URL.createObjectURL(blob);

					// Nom du fichier (ex: Activity_123.csv)
					link.download = `${rec.Activity || "ligne"}_${rec.id}.csv`;

					// T√©l√©charger
					link.click();

					// Nettoyer l‚ÄôURL Blob
					URL.revokeObjectURL(link.href);
				};

				tdActions.appendChild(dlBtn);
				
				if (columnNames.includes('Name')) {
					// Send email
				  const emailBtn = document.createElement('button');
				  //emailBtn.textContent = 'üì©';
				  emailBtn.innerHTML = `
						<svg class="icon" aria-hidden="true">
							<use xlink:href="#mail"></use>
						</svg>
					`;
				  emailBtn.title = "Send email";
				  emailBtn.style.border = 'none';
				  emailBtn.addEventListener('click', async () => {
				    const confirmDelete = confirm(`Send email to "${rec.Name}" ?`);
				    if (!confirmDelete) return;
						await window.grist.selectedTable.update({
							id: rec.id,
							fields: { SendEmail: true }
						});
					});
				  tdActions.appendChild(emailBtn);
		    }
		  }
		};
		
		addButton.addEventListener('click', async () => {
			await grist.selectedTable.create({
			  fields: {
          Activity: "",
          Start_date: today,
          End_date: today,
          Rate_: 0,
        },
			}) 
		});
		
		window.grist.onRecords(records => {
		  allRecords = records;  
		  renderTable(records);
		});
		
		function applyFilters() {
			const nameQuery = searchInput.value.trim().toLowerCase();
			const yearQuery = yearInput.value.trim();

			let filtered = allRecords;

			// Filtre par nom
			if (nameQuery) {
				filtered = filtered.filter(rec =>
				  (rec.Name || "").toLowerCase().includes(nameQuery)
				);
			}

			// Filtre par ann√©e (exact 4 chiffres)
			if (yearQuery.length === 4) {
				filtered = filtered.filter(rec =>
				  rec.Start_date && String(rec.Start_date).startsWith(yearQuery)
				);
			}

			renderTable(filtered);
		}

		// Search by Name
		searchInput.addEventListener('input', () => {
			applyFilters();
		});
		
		// Search by Year
		yearInput.addEventListener("input", () => {
			let val = yearInput.value.trim().replace(/\D/g, "");
			yearInput.value = val; // garde seulement les chiffres
			applyFilters();
		});

	</script>
	
	<script>
    svgPath = 'https://web2018.epfl.ch/8.3.0/icons/icons.svg';
    featherSvgPath = 'https://web2018.epfl.ch/8.3.0/icons/feather-sprite.svg';
  </script>
</body>
</html>


