<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activities Declaration</title>
  <link rel="stylesheet" href="//web2018.epfl.ch/8.2.0/css/elements.min.css">
</head>
<body>
  <header role="banner" class="header">
    <a class="logo" href="#">
      <img src="img/epfl_small.png" alt="Logo EPFL" class="img-fluid">
    </a>
    
    <nav class="ml-auto">
      <div id="user-info"></div>
    </nav>
  </header>

	<div>
		<table id="table">
	    <tr>
	      <th>Activity</th>
	      <th>Start date</th>
	      <th>End date</th>
	      <th>Rate (%)</th>
	      <th>Access</th>
	      <th>Duplicate</th>
	    </tr>
	    <tr>
	      <td>Priya</td>
	      <td>Sharma</td>
	      <td>24</td>
	    </tr>
	    <tr>
	      <td>Arun</td>
	      <td>Singh</td>
	      <td>32</td>
	    </tr>
	    <tr>
	      <td>Sam</td>
	      <td>Watson</td>
	      <td>41</td>
	    </tr>
		</table>
	</div>

  <div id="records"></div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<script>
		window.grist.ready({ requiredAccess: 'full' });

		window.grist.onRecords((records) => {
		  const table = document.getElementById('table');

		  // Efface tout sauf l'entÃªte
		  while (table.rows.length > 1) table.deleteRow(1);

		  if (!records || records.length === 0) {
		    const row = table.insertRow();
		    const cell = row.insertCell();
		    cell.colSpan = 6;
		    cell.textContent = 'Aucune donnÃ©e trouvÃ©e.';
		    cell.style.textAlign = 'center';
		    return;
		  }

		  for (const rec of records) {
		    const row = table.insertRow();

		    // Activity
		    const activityCell = row.insertCell();
		    const activityInput = document.createElement('input');
		    activityInput.value = rec.Activity || '';
		    // ðŸ”¸ mise Ã  jour seulement au blur
		    activityInput.addEventListener('blur', async () => {
		      if (activityInput.value !== rec.Activity) {
		        await window.grist.selectedTable.update({
		          id: rec.id,
		          fields: { Activity: activityInput.value }
		        });
		      }
		    });
		    activityCell.appendChild(activityInput);

		    // Start date
		    const startCell = row.insertCell();
		    const startInput = document.createElement('input');
		    startInput.type = 'date';
		    startInput.value = rec.Start_date || '';
		    startInput.addEventListener('blur', async () => {
		      if (startInput.value !== rec.Start_date) {
		        await window.grist.selectedTable.update({
		          id: rec.id,
		          fields: { Start_date: startInput.value }
		        });
		      }
		    });
		    startCell.appendChild(startInput);

		    // End date
		    const endCell = row.insertCell();
		    const endInput = document.createElement('input');
		    endInput.type = 'date';
		    endInput.value = rec.End_date || '';
		    endInput.addEventListener('blur', async () => {
		      if (endInput.value !== rec.End_date) {
		        await window.grist.selectedTable.update({
		          id: rec.id,
		          fields: { End_date: endInput.value }
		        });
		      }
		    });
		    endCell.appendChild(endInput);

		    // Rate (%)
		    const rateCell = row.insertCell();
		    const rateInput = document.createElement('input');
		    rateInput.type = 'number';
		    rateInput.min = 0;
		    rateInput.max = 100;
		    rateInput.value = rec.Rate_ || 0;
		    rateInput.addEventListener('blur', async () => {
		      const newValue = parseFloat(rateInput.value);
		      if (newValue !== rec.Rate_) {
		        await window.grist.selectedTable.update({
		          id: rec.id,
		          fields: { Rate_: newValue }
		        });
		      }
		    });
		    rateCell.appendChild(rateInput);

		    // Access
		    const accessCell = row.insertCell();
		    const accessBtn = document.createElement('button');
		    accessBtn.textContent = 'Voir';
		    accessBtn.onclick = () => alert(`AccÃ¨s Ã  ${rec.Activity}`);
		    accessCell.appendChild(accessBtn);

		    // Duplicate
		    const dupCell = row.insertCell();
		    const dupBtn = document.createElement('button');
		    dupBtn.textContent = 'Dupliquer';
		    dupBtn.onclick = async () => {
		      await window.grist.selectedTable.add({
		        fields: {
		          Activity: rec.Activity,
		          Start_date: rec.Start_date,
		          End_date: rec.End_date,
		          Rate_: rec.Rate_,
		        },
		      });
		    };
		    dupCell.appendChild(dupBtn);
		  }
		});
	</script>
</body>
</html>


