<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activities Declaration</title>
  <link rel="stylesheet" href="//web2018.epfl.ch/8.2.0/css/elements.min.css">
</head>
<body>
  <header role="banner" class="header">
    <a class="logo" href="#">
      <img src="img/epfl_small.png" alt="Logo EPFL" class="img-fluid">
    </a>
    
    <nav class="ml-auto">
      <div id="user-info"></div>
    </nav>
  </header>

  <div id="records"></div>

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    window.grist.ready();

		async function getCurrentUser() {
			try {
				const response = await window.grist.rpc.call("GET", "https://grist.fsd.epfl.ch/api/scim/v2/Me");
				const user = response.data;

				const display =
				  user.displayName ||
				  user.userName ||
				  (user.emails && user.emails[0]?.value) ||
				  "Utilisateur inconnu";

				document.getElementById("user-info").innerText = `Connecté : ${display}`;
				return user;
			} catch (e) {
				console.error("Impossible de récupérer l’utilisateur :", e);
				document.getElementById("user-info").innerText = "Utilisateur inconnu";
			}
		}

		window.grist.onRecords((records) => {
			const container = document.getElementById('records');
			container.innerHTML = '';

			if (!records || records.length === 0) {
				container.innerHTML = '<p>Aucune donnée trouvée.</p>';
				return;
			}

			for (const rec of records) {
				const div = document.createElement('div');
				div.className = 'card';

				const nameInput = document.createElement('input');
				nameInput.value = rec.Name || '';
				nameInput.addEventListener('change', async () => {
				  await window.grist.docApi.updateRecords('Activities', [
				    { id: rec.id, fields: { Name: nameInput.value } }
				  ]);
				});

				const rateInput = document.createElement('input');
				rateInput.type = 'number';
				rateInput.value = rec.Rate_ || 0;
				rateInput.addEventListener('change', async () => {
				  await window.grist.docApi.updateRecords('Activities', [
				    { id: rec.id, fields: { Rate_: parseFloat(rateInput.value) } }
				  ]);
				});

				div.appendChild(nameInput);
				div.appendChild(rateInput);
				container.appendChild(div);
			}
		});
		
		getCurrentUser();
  </script>
</body>
</html>


